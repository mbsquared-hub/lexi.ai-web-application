<div class="chat-container">
  
  <!-- Welcome Area with Suggestions -->
  <div class="chat-content" *ngIf="messages.length === 0">
   
    <div class="centered-content">
      <div class="lexi-icon">
        <img src="assets/logo-dashboard.svg" alt="Lexi Logo" class="logo-welcome" (error)="onImageError($event)">
      </div>
      <h1 class="main-heading">What would you like to learn?</h1>
    </div>

    <div class="suggestions">
      <p class="suggestions-label">Suggestions on what to ask Lexi</p>
      <div class="suggestion-cards">
        <div class="suggestion-card" 
             [class.disabled]="isRecording"
             (click)="!isRecording && selectSuggestion('What can I ask you to do?')" 
             role="button" 
             [tabindex]="isRecording ? -1 : 0">
          <p>What can I ask you to do?</p>
        </div>
        <div class="suggestion-card" 
             [class.disabled]="isRecording"
             (click)="!isRecording && selectSuggestion('What are the best practice resources for Azure certifications?')" 
             role="button" 
             [tabindex]="isRecording ? -1 : 0">
          <p>What are the best practice resources for Azure certifications?</p>
        </div>
        <div class="suggestion-card" 
             [class.disabled]="isRecording"
             (click)="!isRecording && selectSuggestion('Create 5 practice questions for Azure AD concepts')" 
             role="button" 
             [tabindex]="isRecording ? -1 : 0">
          <p>Create 5 practice questions for Azure AD concepts</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Chat Messages Area -->
  <div class="messages-container" *ngIf="messages.length > 0">
    <div class="messages-list">
      <div *ngFor="let message of messages; let i = index" [class]="'message-wrapper ' + message.sender">
        
        <!-- Lexi's Message -->
        <div *ngIf="message.sender === 'lexi'" class="message lexi-message">
          <div class="message-avatar">
            <img src="assets/logo-dashboard.svg" alt="Lexi" (error)="onImageError($event)">
          </div>
          <div class="message-content">
            <div class="message-header">
              <span class="message-sender">LEXI</span>
            </div>
            <div class="message-text" [innerHTML]="formatMessage(message.text)"></div>
          </div>
        </div>

        <!-- User's Message -->
        <div *ngIf="message.sender === 'user'" class="message user-message">
          <div class="message-content">
            <div class="message-header">
              <span class="message-sender">ME</span>
              <!-- Voice indicator for voice messages -->
              <span *ngIf="message.isVoice" class="voice-badge">
                <span class="material-symbols-outlined">mic</span>
                Voice
              </span>
            </div>
            
            <!-- Show images if present -->
            <div *ngIf="message.images && message.images.length > 0" class="message-images">
              <div class="message-images-grid" [class.single-image]="message.images.length === 1">
                <div *ngFor="let image of message.images" class="message-image-item" (click)="openImageViewer(image)">
                  <img [src]="image" alt="Uploaded screenshot">
                </div>
              </div>
            </div>
            
            <!-- Editing mode -->
            <div *ngIf="editingMessageIndex === i" class="edit-message-container">
              <textarea class="edit-textarea" [(ngModel)]="editedText" rows="3" autofocus></textarea>
              <div class="edit-actions">
                <button class="edit-cancel-btn" (click)="cancelEdit()" type="button">Cancel</button>
                <button class="edit-save-btn" (click)="saveEdit()" type="button">
                  <span class="material-symbols-outlined">send</span>
                  Submit
                </button>
              </div>
            </div>

            <!-- Normal message text with edit button (only show if message has text) -->
            <div *ngIf="editingMessageIndex !== i && message.text" class="message-text-wrapper">
              <div class="message-text">{{ message.text }}</div>
              <button class="edit-message-btn" (click)="startEditingMessage(i)" type="button" title="Edit message">
                <span class="material-symbols-outlined">edit</span>
              </button>
            </div>
          </div>
          <div class="message-avatar">
            <span class="material-symbols-outlined">person</span>
          </div>
        </div>
      </div>

      <!-- Typing Indicator -->
      <div *ngIf="isTyping" class="message-wrapper lexi">
        <div class="message lexi-message">
          <div class="message-avatar">
            <img src="assets/logo-dashboard.svg" alt="Lexi" (error)="onImageError($event)">
          </div>
          <div class="message-content">
            <div class="typing-indicator">
              <span></span>
              <span></span>
              <span></span>
            </div>
          </div>
        </div>
      </div>

      <!-- Stop Generation Button -->
      <div *ngIf="canStopGeneration" class="stop-generation-container">
        <button class="stop-generation-button" (click)="stopGeneration()" type="button">
          <span class="material-symbols-outlined stop-icon">stop_circle</span>
          <span class="stop-label">Stop generating</span>
        </button>
      </div>

      <!-- Regenerate Response Button -->
      <div *ngIf="!isTyping" class="regenerate-container">
        <button class="regenerate-button" 
                (click)="regenerateResponse()" 
                [disabled]="isTyping || isRecording" 
                type="button">
          <span class="material-symbols-outlined">refresh</span>
          <span class="regenerate-label">Regenerate response</span>
        </button>
      </div>
    </div>
  </div>

  <!-- Input Area -->
  <div class="input-area">
    <div class="input-container" [class.has-images]="hasImages">
      <div class="images-preview-integrated" *ngIf="showImagePreview && stagedImages.length">
        <div class="images-preview-header">
          <button class="clear-all-btn" (click)="cancelAllImages()" type="button">Clear all</button>
        </div>
        
        <div class="images-preview-grid">
          <div *ngFor="let image of stagedImages; let i = index" class="image-preview-item">
            <img [src]="image" alt="Preview {{ i + 1 }}" (click)="openImageViewer(image)">
            <button class="remove-image-btn" (click)="removeImage(i); $event.stopPropagation()" title="Remove image" type="button">
              <span class="material-symbols-outlined">close</span>
            </button>
          </div>
        </div>
      </div>

      <!-- Input row -->
      <div class="input-row">
        <!-- File upload button -->
        <label class="upload-button" title="Upload image(s)" [class.disabled]="isUploadDisabled">
          <span class="material-symbols-outlined">add_photo_alternate</span>
          <input type="file" accept="image/*" multiple (change)="onFileSelected($event)" [disabled]="isUploadDisabled" style="display: none;">
        </label>

        <!-- Text input -->
        <input type="text" [placeholder]="inputPlaceholder" class="chat-input" [(ngModel)]="userInput" 
          (keypress)="handleKeyPress($event)" [disabled]="isTyping || isRecording" [readonly]="isRecording" autocomplete="off">

        <!-- Mic button with active state (hide when voice transcript exists) -->
        <button *ngIf="!hasVoiceTranscript" class="mic-button" [class.recording]="isRecording" [class.listening]="isListening"
          (click)="toggleVoiceRecording()" [disabled]="isTyping" type="button" title="Voice input">
          <span class="material-symbols-outlined">{{ isRecording ? 'mic' : 'mic' }}</span>
        </button>

        <!-- Send button -->
        <button class="send-button"  (click)="sendMessage()" [disabled]="isTyping || isRecording" type="button">
          <span class="material-symbols-outlined">arrow_upward</span>
        </button>
      </div>
    </div>

    <p class="copyright">Copyright Â© MB2 | All Rights Reserved</p>
  </div>
</div>

<!-- Image Viewer Modal -->
<div class="image-viewer-overlay" *ngIf="viewingImage" (click)="closeImageViewer()">
  <div class="image-viewer-container">
    <button class="image-viewer-close" (click)="closeImageViewer(); $event.stopPropagation()" type="button">
      <span class="material-symbols-outlined">close</span>
    </button>
    <img [src]="viewingImage" alt="Full size image" (click)="$event.stopPropagation()">
  </div>
</div>